<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üöÄ Cyberpunk Spotify Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ---------- Cyberpunk Dark Theme ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    :root {
      --bg: #111;
      --fg: #eee;
      --accent: #39ff14;
      --accent-dim: rgba(57,255,20,0.2);
      --neon: drop-shadow(0 0 6px var(--accent));
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Orbitron', sans-serif;
      background: var(--bg);
      color: var(--fg);
      padding: 1rem;
      line-height: 1.4;
    }
    h1,h2 { margin: 1rem 0; text-shadow: 0 0 4px var(--accent); }
    button, select, input[type="range"], input[type="text"] {
      font-family: inherit;
      background: var(--accent-dim);
      color: var(--fg);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 0.5rem;
      margin: 0.5rem 0;
      text-shadow: var(--neon);
      transition: background .3s, transform .1s;
    }
    button:hover, select:hover, input:hover { background: var(--accent-dim); transform: scale(1.02); }
    button:disabled, select:disabled, input:disabled { opacity: 0.4; }
    ul { list-style: none; margin: 0.5rem 0; padding: 0; }
    li {
      padding: 0.4rem;
      border-bottom: 1px solid var(--accent-dim);
      cursor: pointer;
    }
    li:hover { background: var(--accent-dim); }
    label { display: block; margin: 0.5rem 0; }
    #controls, #nowPlaying, #playlistSection, #trackSection, #queueSection, #searchSection {
      border: 1px solid var(--accent-dim);
      padding: 1rem; margin: 1rem 0;
      border-radius: 6px;
      box-shadow: var(--neon);
    }
    #currentTrack img { width:80px; height:80px; border-radius:4px; margin-right:1rem; }
    #currentTrack { display:flex; align-items:center; }
    #visualizer { display:none; width:100%; height:100px; background:#000; margin-top:0.5rem; }
    #offlineStatus { color: #f00; display:none; margin-top:1rem; text-shadow:0 0 4px red; }
  </style>
</head>
<body>

  <h1>üöÄ Cyberpunk Spotify Player</h1>
  <div id="offlineStatus">‚ö†Ô∏è Offline ‚Äì attempting to reconnect‚Ä¶</div>
  <div id="status" style="font-weight:bold; margin:1rem 0;"></div>

  <!-- Authentication -->
  <button id="login">Log in with Spotify</button>

  <!-- Playback + Device Controls -->
  <div id="controls">
    <button id="prevBtn" disabled>‚èÆÔ∏è Prev</button>
    <button id="playPause" disabled>‚ñ∂Ô∏è Play/Pause</button>
    <button id="nextBtn" disabled>‚è≠Ô∏è Next</button>
    <button id="shuffleBtn" disabled>üîÄ Shuffle</button>
    <button id="repeatBtn" disabled>üîÅ Repeat: Off</button>

    <label>
      Volume
      <input type="range" id="volumeSlider" min="0" max="100" value="50" disabled>
    </label>

    <label>
      Device
      <select id="deviceSelect" disabled></select>
    </label>

    <button id="darkModeToggle">üåô Toggle Dark Mode</button>
  </div>

  <!-- Now Playing -->
  <div id="nowPlaying">
    <h2>Now Playing</h2>
    <div id="currentTrack">
      <img id="trackArt" src="" alt="">
      <div>
        <div id="trackInfo">Not playing</div>
        <input type="range" id="progressBar" min="0" max="100" value="0" disabled>
      </div>
    </div>
    <!-- Visualizer & EQ -->
    <label>
      Equalizer
      <select id="eqPreset" disabled>
        <option value="flat">Flat</option>
        <option value="bass">Bass Boost</option>
        <option value="treble">Treble Boost</option>
        <option value="vocal">Vocal Boost</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="enableVisualizer" disabled>
      Enable Visualizer
    </label>
    <canvas id="visualizer"></canvas>
  </div>

  <!-- Playlists -->
  <div id="playlistSection">
    <h2>Playlists</h2>
    <ul id="playlists"></ul>
  </div>

  <!-- Tracks in Context -->
  <div id="trackSection">
    <h2>Tracks</h2>
    <ul id="tracks"></ul>
  </div>

  <!-- Queue Management -->
  <div id="queueSection">
    <h2>Queue</h2>
    <ul id="queue"></ul>
  </div>

  <!-- Search & Add/Queue -->
  <div id="searchSection">
    <h2>Search & Add</h2>
    <input type="text" id="searchQuery" placeholder="Search for a song‚Ä¶" disabled>
    <button id="searchBtn" disabled>Search</button>
    <label>
      Add search results to playlist:
      <select id="playlistSelect" disabled></select>
    </label>
    <ul id="searchResults"></ul>
  </div>

<script>
  // ---------- CONFIG ----------
  const client_id    = 'b00e3fe2a9394a86a64048c96a3ff5f3';
  const redirect_uri = window.location.origin + window.location.pathname;
  const scopes       = [
    'streaming','user-read-private','user-read-email',
    'user-read-playback-state','user-modify-playback-state',
    'playlist-read-private','playlist-modify-public','playlist-modify-private'
  ].join(' ');

  // PKCE storage keys
  const STATE_KEY = 'spotify_auth_state';
  const CODE_VERIFIER_KEY = 'spotify_code_verifier';

  // Globals
  let access_token, player, pollInterval, playlistTrackUris = [], queuedTracks = [];
  
  // ---------- UTILS ----------
  function randStr(len) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let s=''; const arr = new Uint8Array(len); crypto.getRandomValues(arr);
    arr.forEach(i=>s += chars[i % chars.length]);
    return s;
  }
  function b64Url(buff) {
    return btoa(String.fromCharCode(...new Uint8Array(buff)))
      .replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
  }
  async function sha256(msg) {
    const enc = new TextEncoder().encode(msg);
    return crypto.subtle.digest('SHA-256', enc);
  }
  function api(path, opts={}) {
    opts.headers = { ...(opts.headers||{}), 'Authorization':'Bearer '+access_token };
    return fetch('https://api.spotify.com/v1'+path, opts).then(r=>r.json());
  }

  // ---------- AUTH FLOW ----------
  async function redirectToAuth() {
    const state = randStr(16), cv = randStr(64);
    localStorage.setItem(STATE_KEY, state);
    localStorage.setItem(CODE_VERIFIER_KEY, cv);
    const hash = await sha256(cv), challenge = b64Url(hash);
    const params = new URLSearchParams({
      response_type:'code', client_id, scope:scopes,
      redirect_uri, state,
      code_challenge_method:'S256', code_challenge:challenge,
      show_dialog:'true'
    });
    window.location = 'https://accounts.spotify.com/authorize?'+params;
  }

  async function handleRedirect() {
    const qs = new URLSearchParams(window.location.search);
    const code = qs.get('code'), state = qs.get('state');
    if (!code) return;
    if (state !== localStorage.getItem(STATE_KEY)) return alert('Auth mismatch');
    localStorage.removeItem(STATE_KEY);
    const cv = localStorage.getItem(CODE_VERIFIER_KEY);
    localStorage.removeItem(CODE_VERIFIER_KEY);
    const token = await fetch('https://accounts.spotify.com/api/token',{
      method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        grant_type:'authorization_code', code, redirect_uri,
        client_id, code_verifier:cv
      })
    }).then(r=>r.json());
    if (!token.access_token) return alert('Token error');
    access_token = token.access_token;
    history.replaceState(null,'',redirect_uri);
    document.getElementById('status').textContent = '‚úÖ Logged in';
    enableControls();
    initPlayerAndUI();
  }

  // ---------- ENABLE UI ----------
  function enableControls() {
    [
      'prevBtn','playPause','nextBtn','shuffleBtn','repeatBtn',
      'volumeSlider','deviceSelect','eqPreset','enableVisualizer',
      'searchQuery','searchBtn'
    ].forEach(id=>document.getElementById(id).disabled = false);
  }

  // ---------- INIT PLAYER & UI ----------
  function initPlayerAndUI() {
    fetchPlaylists();
    fetchDevices();
    setupEQVisualizer();
    loadSDK();
    document.getElementById('searchBtn').onclick = searchTracks;
    document.getElementById('shuffleBtn').onclick = ()=>api('/me/player/shuffle?state=true',{method:'PUT'});
    document.getElementById('repeatBtn').onclick = toggleRepeat;
    document.getElementById('darkModeToggle').onclick = ()=>document.body.classList.toggle('dark');
    window.addEventListener('offline', ()=>document.getElementById('offlineStatus').style.display='block');
    window.addEventListener('online', ()=>document.getElementById('offlineStatus').style.display='none');
  }

  // ---------- PLAYLISTS & COLLABORATION ----------
  async function fetchPlaylists() {
    const data = await api('/me/playlists?limit=50');
    const ul = document.getElementById('playlists'), sel = document.getElementById('playlistSelect');
    ul.innerHTML=''; sel.innerHTML='';
    // Liked Songs
    const liked = document.createElement('li');
    liked.textContent='‚ù§Ô∏è Liked Songs'; liked.onclick = fetchLiked;
    ul.appendChild(liked);
    data.items.forEach(pl=>{
      const li = document.createElement('li');
      li.textContent=pl.name; li.onclick=()=>fetchTracks(pl.id);
      ul.appendChild(li);
      const opt = document.createElement('option');
      opt.value=pl.id; opt.textContent=pl.name; sel.appendChild(opt);
    });
  }
  async function fetchTracks(id) { // playlist
    currentContext=id;
    const data = await api(`/playlists/${id}/tracks?limit=100`);
    const tracks = data.items.map(i=>i.track);
    populateTracks(tracks);
    startCollabPolling(id);
  }
  async function fetchLiked() {
    currentContext='liked';
    const data = await api('/me/tracks?limit=100');
    populateTracks(data.items.map(i=>i.track));
    clearInterval(pollInterval);
  }
  function populateTracks(tracks) {
    const ul = document.getElementById('tracks');
    ul.innerHTML=''; playlistTrackUris = tracks.map(t=>t.uri);
    tracks.forEach((t,i)=>{
      const li = document.createElement('li');
      li.textContent=`${t.name} ‚Äî ${t.artists.map(a=>a.name).join(', ')}`;
      li.onclick=()=>playFrom(currentContext,t.uri,i);
      ul.appendChild(li);
    });
  }
  function startCollabPolling(plId) {
    clearInterval(pollInterval);
    pollInterval = setInterval(async ()=>{
      const data = await api(`/playlists/${plId}/tracks?limit=100`);
      const uris = data.items.map(i=>i.track.uri);
      const newUris = uris.filter(u=>!playlistTrackUris.includes(u));
      newUris.forEach(u=>{ queueTrack(u); });
      if (newUris.length) playlistTrackUris = uris;
    }, 30000);
  }

  // ---------- PLAY/QUEUE CONTROLS ----------
  function playFrom(ctx,uri,pos) {
    const body = ctx==='liked'
      ? { uris:[uri] }
      : { context_uri:`spotify:playlist:${ctx}`, offset:{position:pos} };
    api('/me/player/play',{method:'PUT',body:JSON.stringify(body)});
  }
  function queueTrack(uri) {
    api(`/me/player/queue?uri=${encodeURIComponent(uri)}`,{method:'POST'});
    queuedTracks.push(uri); updateQueueUI();
  }
  function updateQueueUI() {
    const ul = document.getElementById('queue');
    ul.innerHTML='';
    queuedTracks.forEach((uri,i)=>{
      const li = document.createElement('li');
      li.textContent=uri.split(':').pop(); // stub, ideally fetch track name
      // Remove button
      const x = document.createElement('button');
      x.textContent='‚úñ'; x.onclick=e=>{e.stopPropagation(); queuedTracks.splice(i,1);updateQueueUI();};
      li.prepend(x);
      ul.appendChild(li);
    });
  }

  // ---------- DEVICE SELECTOR ----------
  async function fetchDevices() {
    const data = await api('/me/player/devices');
    const sel = document.getElementById('deviceSelect');
    sel.innerHTML='';
    data.devices.forEach(d=>{
      const opt = document.createElement('option');
      opt.value=d.id; opt.text=d.name + (d.is_active?' (active)':'');
      sel.appendChild(opt);
    });
    sel.onchange = ()=>api('/me/player',{method:'PUT',body:JSON.stringify({device_ids:[sel.value]})});
  }

  // ---------- SEARCH & ADD ----------
  async function searchTracks() {
    const q = document.getElementById('searchQuery').value.trim();
    if (!q) return alert('Enter text');
    const data = await api(`/search?type=track&limit=10&q=${encodeURIComponent(q)}`);
    const ul = document.getElementById('searchResults');
    ul.innerHTML='';
    data.tracks.items.forEach(t=>{
      const li=document.createElement('li');
      const playBtn=document.createElement('button'); playBtn.text='‚ñ∂Ô∏è'; playBtn.onclick=e=>{e.stopPropagation(); playSingle(t.uri);};
      const addBtn=document.createElement('button'); addBtn.text='‚ûï'; addBtn.onclick=e=>{e.stopPropagation();const pid=document.getElementById('playlistSelect').value;api(`/playlists/${pid}/tracks`,{method:'POST',body:JSON.stringify({uris:[t.uri]})}).then(()=>alert('‚úÖ Added'));};
      const queueBtn=document.createElement('button'); queueBtn.text='üì•'; queueBtn.onclick=e=>{e.stopPropagation();queueTrack(t.uri);};
      li.textContent=`${t.name}‚Äî${t.artists.map(a=>a.name).join(', ')}`;
      li.prepend(playBtn,' ',addBtn,' ',queueBtn);
      ul.appendChild(li);
    });
  }
  function playSingle(uri) {
    api('/me/player/play',{method:'PUT',body:JSON.stringify({uris:[uri]})});
  }

  // ---------- REPEAT & VOLUME ----------
  let repeatStates=['off','context','track'], rptIdx=0;
  function toggleRepeat() {
    rptIdx=(rptIdx+1)%3;
    api(`/me/player/repeat?state=${repeatStates[rptIdx]}`,{method:'PUT'});
    document.getElementById('repeatBtn').textContent=`üîÅ Repeat: ${repeatStates[rptIdx]}`;
  }
  document.getElementById('volumeSlider').oninput = e=>api(`/me/player/volume?volume_percent=${e.target.value}`,{method:'PUT'});

  // ---------- PROGRESS BAR & NOW PLAYING ----------
  function loadSDK() {
    if (!window.Spotify) {
      const s=document.createElement('script');
      s.src='https://sdk.scdn.co/spotify-player.js';
      document.head.appendChild(s);
    }
    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({ name:'Cyberpunk PKCE', getOAuthToken:cb=>cb(access_token) });
      player.connect().then(ok=>{
        if (!ok) return;
        document.getElementById('status').textContent='üéß Device Ready';
        document.getElementById('playPause').disabled=false;
        ['prevBtn','nextBtn'].forEach(id=>{
          document.getElementById(id).onclick = ()=>api(`/me/player/${id.includes('prev')?'previous':'next'}`,{method:'POST'});
        });
        player.addListener('player_state_changed', state=>{
          if (!state) return;
          player.resume(); // auto‚Äëresume
          const paused=state.paused;
          document.getElementById('playPause').textContent = paused?'‚ñ∂Ô∏è Play':'‚è∏Ô∏è Pause';
          const t=state.track_window.current_track;
          document.getElementById('trackArt').src = t.album.images[0]?.url;
          document.getElementById('trackInfo').textContent = `${t.name} ‚Äî ${t.artists.map(a=>a.name).join(', ')}`;
          const pb=document.getElementById('progressBar');
          pb.max=state.track_window.duration; pb.value=state.position;
        });
        document.getElementById('progressBar').onchange = e=>api(`/me/player/seek?position_ms=${e.target.value}`,{method:'PUT'});
        document.getElementById('playPause').onclick = ()=>player.togglePlay();
      });
    };
  }

  // ---------- EQUALIZER & VISUALIZER ----------
  let audioCtx, eqFilters=[], analyser;
  function setupEQVisualizer() {
    audioCtx = new (AudioContext||webkitAudioContext)();
    const freqs=[60,170,350,1000,3500,10000];
    eqFilters = freqs.map(f=>{
      const fs=audioCtx.createBiquadFilter();
      fs.type='peaking'; fs.frequency.value=f; fs.Q.value=1; fs.gain.value=0;
      return fs;
    });
    analyser = audioCtx.createAnalyser(); analyser.fftSize=256;
    eqFilters.reduce((prev,cur)=>{ prev.connect(cur); return cur; })
      .connect(analyser).connect(audioCtx.destination);
    document.getElementById('enableVisualizer').onchange=e=>{
      const canvas=document.getElementById('visualizer');
      canvas.style.display=e.target.checked?'block':'none';
      if (e.target.checked) drawVisual(canvas.getContext('2d'));
    };
    document.getElementById('eqPreset').onchange=e=>{
      const p=e.target.value;
      eqFilters.forEach((f,i)=>{
        if(p=='bass') f.gain.value=i<2?6:0;
        else if(p=='treble') f.gain.value=i>3?6:0;
        else if(p=='vocal') f.gain.value=(i>1&&i<4)?4:0;
        else f.gain.value=0;
      });
    };
  }
  function drawVisual(ctx) {
    const canvas=document.getElementById('visualizer');
    const buf=new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buf);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const w=canvas.width/buf.length;
    buf.forEach((v,i)=>{
      ctx.fillStyle=`hsl(${i/buf.length*360},100%,50%)`;
      const h=(v/255)*canvas.height;
      ctx.fillRect(i*w,canvas.height-h,w,h);
    });
    requestAnimationFrame(()=>drawVisual(ctx));
  }

  // ---------- BOOTSTRAP ----------
  document.getElementById('login').onclick = redirectToAuth;
  window.addEventListener('load', handleRedirect);
</script>

</body>
</html>
