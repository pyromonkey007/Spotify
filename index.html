<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Player + Search (Debug)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    button, select, input, a { margin: 0.5rem 0; padding: 0.4rem; font-size: 1rem; }
    a { display: inline-block; background: #1DB954; color: #fff; text-decoration: none; border-radius: 4px; }
    ul { list-style: none; padding: 0; }
    li { cursor: pointer; margin: 0.25rem 0; }
    li:hover { text-decoration: underline; }
    label { display: block; margin-top: 1rem; }
    pre#debugHash { color: red; word-break: break-all; }
  </style>
</head>
<body>
  <!-- DEBUG: shows the raw hash fragment if Safari delivers one -->
  <pre id="debugHash">–– no hash fragment ––</pre>

  <h1>Spotify Player + Search</h1>

  <!-- Direct link into the Implicit Grant flow -->
  <a
    id="login"
    href="https://accounts.spotify.com/authorize?response_type=token&client_id=b00e3fe2a9394a86a64048c96a3ff5f3&redirect_uri=https%3A%2F%2Fpyromonkey007.github.io%2FSpotify%2F&scope=streaming%20user-read-private%20user-read-email%20user-read-playback-state%20user-modify-playback-state%20playlist-read-private%20playlist-modify-public%20playlist-modify-private&show_dialog=true&login_hint=nikhil.n.bhatnagar%40gmail.com"
  >
    Log in with Spotify
  </a>
  <div id="status" style="margin:1rem 0; font-weight:bold;"></div>

  <label>
    Add search results to:
    <select id="playlistSelect"></select>
  </label>

  <h2>Your Playlists</h2>
  <ul id="playlists"></ul>
  <button id="playPause" disabled>Play / Pause</button>

  <h2>Search Tracks</h2>
  <input id="searchQuery" placeholder="Enter track name…" size="40"/>
  <button id="searchBtn">Search</button>
  <ul id="searchResults"></ul>

  <script>
    // --- DEBUG: surface any hash fragment Safari gives us ---
    document.getElementById('debugHash').innerText =
      window.location.hash || '–– no hash fragment ––';

    // —— CONFIG ——
    const client_id    = 'b00e3fe2a9394a86a64048c96a3ff5f3';
    const redirect_uri = window.location.origin + window.location.pathname;
    const scopes = [
      'streaming',
      'user-read-private',
      'user-read-email',
      'user-read-playback-state',
      'user-modify-playback-state',
      'playlist-read-private',
      'playlist-modify-public',
      'playlist-modify-private'
    ];

    // Parse access token from URL hash (Implicit Grant)
    window.addEventListener('load', () => {
      if (location.hash) {
        const hash = location.hash.substring(1).split('&').reduce((acc, part) => {
          const [k,v] = part.split('=');
          acc[k] = decodeURIComponent(v);
          return acc;
        }, {});
        window.access_token = hash.access_token;
        history.replaceState(null, '', redirect_uri);
        if (access_token) {
          document.getElementById('status').textContent = '✅ Logged in';
          loadSDKAndPlayer();
          fetchPlaylists();
        }
      }
    });

    // Fetch & render playlists + populate dropdown
    async function fetchPlaylists() {
      const res  = await fetch('https://api.spotify.com/v1/me/playlists', {
        headers: { 'Authorization': 'Bearer ' + access_token }
      });
      const data = await res.json();
      const ul  = document.getElementById('playlists');
      const sel = document.getElementById('playlistSelect');
      ul.innerHTML = '';
      sel.innerHTML = '';
      data.items.forEach(pl => {
        // Playback list
        const li = document.createElement('li');
        li.textContent = pl.name;
        li.onclick = () => playPlaylist(pl.id);
        ul.appendChild(li);
        // Dropdown
        const opt = document.createElement('option');
        opt.value = pl.id;
        opt.textContent = pl.name;
        sel.appendChild(opt);
      });
    }

    // Start playing a playlist
    function playPlaylist(playlistId) {
      fetch('https://api.spotify.com/v1/me/player/play', {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type':  'application/json'
        },
        body: JSON.stringify({ context_uri: 'spotify:playlist:' + playlistId })
      });
    }

    // Load Web Playback SDK, transfer playback & hook play/pause + auto-resume
    function loadSDKAndPlayer() {
      if (!window.Spotify) {
        const s = document.createElement('script');
        s.src = 'https://sdk.scdn.co/spotify-player.js';
        document.head.appendChild(s);
      }
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'iPhone Player',
          getOAuthToken: cb => cb(access_token),
        });
        player.connect().then(success => {
          if (success) {
            document.getElementById('playPause').disabled = false;
            player.addListener('player_state_changed', ({ paused }) => {
              if (paused) player.resume();
            });
            player.addListener('ready', ({ device_id }) => {
              fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + access_token,
                  'Content-Type':  'application/json'
                },
                body: JSON.stringify({ device_ids: [ device_id ] })
              });
            });
          }
        });
        document.getElementById('playPause').onclick = () => player.togglePlay();
      };
    }

    // Wire up search
    document.getElementById('searchBtn').onclick = searchTracks;
    async function searchTracks() {
      const q = document.getElementById('searchQuery').value.trim();
      if (!q) return alert('Enter a search term');
      const res = await fetch(
        `https://api.spotify.com/v1/search?type=track&limit=10&q=${encodeURIComponent(q)}`,
        { headers: { 'Authorization': 'Bearer ' + access_token } }
      );
      const { tracks } = await res.json();
      const ul = document.getElementById('searchResults');
      ul.innerHTML = '';
      tracks.items.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.name} — ${t.artists.map(a=>a.name).join(', ')}`;
        li.onclick = () => addTrackToPlaylist(
          document.getElementById('playlistSelect').value,
          t.uri
        );
        ul.appendChild(li);
      });
    }

    // Add a track to the chosen playlist
    async function addTrackToPlaylist(playlistId, trackUri) {
      const res = await fetch(
        `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + access_token,
            'Content-Type':  'application/json'
          },
          body: JSON.stringify({ uris: [ trackUri ] })
        }
      );
      if (res.ok) {
        alert('✅ Track added!');
      } else {
        console.error(await res.json());
        alert('❌ Failed to add track—see console.');
      }
    }
  </script>
</body>
</html>
