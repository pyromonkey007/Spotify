<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Player + Dark Mode & Controls</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg: #fff; --fg: #000; --accent: #1DB954; --accent-dim: rgba(29,185,84,0.2);
    }
    body { background: var(--bg); color: var(--fg); font-family: sans-serif; max-width: 800px; margin: 1rem auto; padding: 1rem; transition: background .3s, color .3s; }
    body.dark { --bg: #111; --fg: #eee; }
    h1, h2 { margin-top: 1rem; }
    button, select { margin: .5rem 0; padding: .5rem 1rem; font-size: 1rem; background: var(--accent-dim); border: 1px solid var(--accent); color: var(--fg); border-radius: 4px; cursor: pointer; }
    button:disabled, select:disabled { opacity: .5; cursor: default; }
    #controls, #nowPlaying, #playlistSection, #trackSection { border: 1px solid var(--accent-dim); padding: 1rem; margin: 1rem 0; border-radius: 6px; }
    ul { list-style: none; padding: 0; }
    li { padding: .5rem; border-bottom: 1px solid var(--accent-dim); cursor: pointer; }
    li:hover { background: var(--accent-dim); }
    li.playing { background: var(--accent); color: var(--bg); }
    #nowPlaying { display: flex; align-items: center; }
    #nowPlaying img { width: 80px; height: 80px; margin-right: 1rem; border-radius: 4px; }
    #status { font-weight: bold; margin: .5rem 0; }
  </style>
</head>
<body>
  <h1>Spotify Player</h1>
  <div id="status"></div>
  <button id="login">Log in with Spotify</button>
  <div id="controls">
    <button id="prevBtn" disabled>‚èÆÔ∏è Prev</button>
    <button id="playPauseBtn" disabled>‚ñ∂Ô∏è Play/Pause</button>
    <button id="nextBtn" disabled>‚è≠Ô∏è Next</button>
    <button id="shuffleBtn" disabled>üîÄ Shuffle</button>
    <button id="repeatBtn" disabled>üîÅ Repeat: Off</button>
    <button id="darkModeToggle">üåô Dark Mode</button>
  </div>
  <div id="nowPlaying">
    <img id="trackArt" src="" alt="Album Art">
    <div>
      <div id="trackInfo">Not playing</div>
    </div>
  </div>
  <div id="playlistSection">
    <h2>Playlists</h2>
    <ul id="playlists"></ul>
  </div>
  <div id="trackSection">
    <h2>Tracks</h2>
    <ul id="tracks"></ul>
  </div>

  <script>
    // ‚Äî‚Äî CONFIG ‚Äî‚Äî 
    const client_id     = 'b00e3fe2a9394a86a64048c96a3ff5f3';
    const redirect_uri  = 'https://pyromonkey007.github.io/Spotify/';
    const scopes        = [
      'streaming',
      'user-read-private',
      'user-read-email',
      'user-read-playback-state',
      'user-modify-playback-state',
      'playlist-read-private',
      'playlist-read-collaborative'
    ].join(' ');
    const STATE_KEY     = 'spotify_pkce_state';
    const VERIFIER_KEY  = 'spotify_pkce_verifier';

    let access_token, player, currentPlaylistId, playlistTracks = [];

    // Util functions
    function randStr(len) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s = '', arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      arr.forEach(i=> s += chars[i % chars.length]);
      return s;
    }
    function b64url(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
    }
    async function sha256(msg) {
      const enc = new TextEncoder().encode(msg);
      return crypto.subtle.digest('SHA-256', enc);
    }
    function api(path, opts={}) {
      opts.headers = {
        ...(opts.headers||{}),
        'Authorization': 'Bearer ' + access_token
      };
      return fetch('https://api.spotify.com/v1' + path, opts).then(r=>r.json());
    }

    // 1) PKCE auth
    async function redirectToAuth() {
      const state = randStr(16), verifier = randStr(64);
      sessionStorage.setItem(STATE_KEY, state);
      sessionStorage.setItem(VERIFIER_KEY, verifier);
      const challenge = b64url(await sha256(verifier));
      const params = new URLSearchParams({
        response_type: 'code',
        client_id, scope: scopes,
        redirect_uri, state,
        code_challenge_method: 'S256',
        code_challenge: challenge,
        show_dialog: 'true'
      });
      location = 'https://accounts.spotify.com/authorize?' + params;
    }

    // 2) Handle redirect
    async function handleRedirect() {
      const qs = new URLSearchParams(location.search);
      const code = qs.get('code'), state = qs.get('state');
      if (!code) return;
      const saved = sessionStorage.getItem(STATE_KEY);
      if (state !== saved) {
        status('‚ùå State mismatch. Try again.');
        return;
      }
      sessionStorage.removeItem(STATE_KEY);
      const verifier = sessionStorage.getItem(VERIFIER_KEY);
      sessionStorage.removeItem(VERIFIER_KEY);

      // Exchange code
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        code, redirect_uri, client_id, code_verifier: verifier
      });
      const tok = await fetch('https://accounts.spotify.com/api/token',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      }).then(r=>r.json());
      if (!tok.access_token) {
        console.error(tok);
        status('‚ùå Token exchange failed');
        return;
      }
      access_token = tok.access_token;
      history.replaceState(null,'',redirect_uri);
      status('‚úÖ Logged in');
      initApp();
    }

    // 3) Initialize UI & player
    function initApp() {
      ['prevBtn','playPauseBtn','nextBtn','shuffleBtn','repeatBtn'].forEach(id=>
        document.getElementById(id).disabled = false
      );
      document.getElementById('darkModeToggle').onclick = () =>
        document.body.classList.toggle('dark');

      loadPlaylists();
      loadSDK();

      document.getElementById('prevBtn').onclick = ()=>player.previousTrack();
      document.getElementById('nextBtn').onclick = ()=>player.nextTrack();
      document.getElementById('playPauseBtn').onclick = ()=>player.togglePlay();
      document.getElementById('shuffleBtn').onclick = toggleShuffle;
      document.getElementById('repeatBtn').onclick  = toggleRepeat;
    }

    function status(msg) {
      document.getElementById('status').textContent = msg;
    }

    // 4) Fetch playlists (including collaborative)
    async function loadPlaylists() {
      let data = await api('/me/playlists?limit=50');
      const ul = document.getElementById('playlists');
      ul.innerHTML = '';
      data.items.forEach(pl => {
        const li = document.createElement('li');
        li.textContent = pl.name;
        li.onclick = () => loadTracks(pl.id);
        ul.appendChild(li);
      });
    }

    // 5) Fetch tracks of a playlist
    async function loadTracks(id) {
      currentPlaylistId = id;
      const data = await api(`/playlists/${id}/tracks?limit=100`);
      playlistTracks = data.items.map(i=>i.track.uri);
      const ul = document.getElementById('tracks');
      ul.innerHTML = '';
      data.items.forEach((i, idx) => {
        const t = i.track;
        const li = document.createElement('li');
        li.textContent = `${t.name} ‚Äî ${t.artists.map(a=>a.name).join(', ')}`;
        li.onclick = () => playTrackAt(idx);
        ul.appendChild(li);
      });
    }

    // Play track at position
    function playTrackAt(index) {
      api('/me/player/play',{
        method:'PUT',
        body: JSON.stringify({
          context_uri: `spotify:playlist:${currentPlaylistId}`,
          offset: { position: index }
        })
      });
    }

    // 6) Initialize Web Playback SDK
    function loadSDK() {
      if (!window.Spotify) {
        const s = document.createElement('script');
        s.src = 'https://sdk.scdn.co/spotify-player.js';
        document.head.appendChild(s);
      }
      window.onSpotifyWebPlaybackSDKReady = () => {
        player = new Spotify.Player({
          name: 'Web Player',
          getOAuthToken: cb => cb(access_token)
        });
        player.addListener('ready', ({ device_id }) => {
          status('Device ready');
          // transfer playback
          api('/me/player',{method:'PUT',body:JSON.stringify({device_ids:[device_id]})});
        });
        player.addListener('player_state_changed', state => {
          if (!state) return;
          // auto-resume
          if (state.paused) player.resume();
          // update now playing
          const t = state.track_window.current_track;
          document.getElementById('trackArt').src = t.album.images[0]?.url;
          document.getElementById('trackInfo').textContent =
            `${t.name} ‚Äî ${t.artists.map(a=>a.name).join(', ')}`;
          // highlight current track
          const lis = document.querySelectorAll('#tracks li');
          lis.forEach((li,i)=> li.classList.toggle('playing', i === state.track_window.previous_tracks.length));
        });
        player.connect();
      };
    }

    // Toggle shuffle
    async function toggleShuffle() {
      // get current shuffle
      const s = await api('/me/player');
      const next = !s.shuffle_state;
      await api(`/me/player/shuffle?state=${next}`,{method:'PUT'});
      document.getElementById('shuffleBtn').textContent = next ? 'üîÄ Shuffle On' : 'üîÄ Shuffle Off';
    }

    // Toggle repeat
    let rptStates = ['off','context','track'], rptIdx = 0;
    async function toggleRepeat() {
      rptIdx = (rptIdx + 1) % 3;
      await api(`/me/player/repeat?state=${rptStates[rptIdx]}`,{method:'PUT'});
      document.getElementById('repeatBtn').textContent = `üîÅ Repeat: ${rptStates[rptIdx]}`;
    }

    // Wire up
    document.getElementById('login').onclick = redirectToAuth;
    window.addEventListener('load', handleRedirect);
  </script>
</body>
</html>
