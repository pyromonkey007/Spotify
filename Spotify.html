<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Minimal Spotify Web Player + Search</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    button, select, input { margin: 0.5rem 0; padding: 0.4rem; font-size: 1rem; }
    ul { list-style: none; padding: 0; }
    li { cursor: pointer; margin: 0.25rem 0; }
    li:hover { text-decoration: underline; }
    label { display: block; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Spotify Player + Search</h1>
  <button id="login">Log in with Spotify</button>
  <div id="status" style="margin:1rem 0; font-weight:bold;"></div>

  <label>
    Add search results to:
    <select id="playlistSelect"></select>
  </label>

  <h2>Your Playlists</h2>
  <ul id="playlists"></ul>
  <button id="playPause" disabled>Play / Pause</button>

  <h2>Search Tracks</h2>
  <input id="searchQuery" placeholder="Enter track name…" size="40"/>
  <button id="searchBtn">Search</button>
  <ul id="searchResults"></ul>

  <script>
    // —— CONFIGURE ——
    const client_id    = 'YOUR_CLIENT_ID_HERE';  
    const redirect_uri = window.location.origin + window.location.pathname;
    const scopes = [
      'streaming',
      'user-read-private',
      'user-read-email',
      'user-read-playback-state',
      'user-modify-playback-state',
      'playlist-read-private',
      'playlist-modify-public',
      'playlist-modify-private'
    ];

    // 1) Parse token from URL hash
    window.addEventListener('load', () => {
      if (location.hash) {
        const hash = location.hash.substring(1).split('&').reduce((acc, part) => {
          const [k,v] = part.split('=');
          acc[k] = decodeURIComponent(v);
          return acc;
        }, {});
        window.access_token = hash.access_token;
        history.replaceState(null, '', redirect_uri);
        if (access_token) {
          document.getElementById('status').textContent = '✅ Logged in';
          loadSDKAndPlayer();
          fetchPlaylists();
        }
      }
    });

    // 2) Trigger Implicit Grant login
    document.getElementById('login').onclick = () => {
      const url = 'https://accounts.spotify.com/authorize'
        + '?response_type=token'
        + '&client_id='    + encodeURIComponent(client_id)
        + '&scope='        + encodeURIComponent(scopes.join(' '))
        + '&redirect_uri=' + encodeURIComponent(redirect_uri)
        + '&show_dialog=true';
      window.location = url;
    };

    // 3) Fetch & render playlists + dropdown
    async function fetchPlaylists() {
      const res  = await fetch('https://api.spotify.com/v1/me/playlists', {
        headers: { 'Authorization': 'Bearer ' + access_token }
      });
      const data = await res.json();

      // Populate ul#playlists for playback
      const ul = document.getElementById('playlists');
      ul.innerHTML = '';
      // Populate select#playlistSelect for additions
      const sel = document.getElementById('playlistSelect');
      sel.innerHTML = '';
      data.items.forEach(pl => {
        // playback list
        const li = document.createElement('li');
        li.textContent = pl.name;
        li.onclick = () => playPlaylist(pl.id);
        ul.appendChild(li);
        // add-to dropdown
        const opt = document.createElement('option');
        opt.value = pl.id;
        opt.textContent = pl.name;
        sel.appendChild(opt);
      });
    }

    // 4) Play a playlist by ID
    function playPlaylist(playlistId) {
      fetch('https://api.spotify.com/v1/me/player/play', {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type':  'application/json'
        },
        body: JSON.stringify({ context_uri: 'spotify:playlist:' + playlistId })
      });
    }

    // 5) Load Web Playback SDK & hook play/pause + auto-resume
    function loadSDKAndPlayer() {
      if (!window.Spotify) {
        const s = document.createElement('script');
        s.src = 'https://sdk.scdn.co/spotify-player.js';
        document.head.appendChild(s);
      }
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Work Player',
          getOAuthToken: cb => cb(access_token),
        });
        player.connect().then(success => {
          if (success) {
            document.getElementById('playPause').disabled = false;
            // auto-resume if paused by network
            player.addListener('player_state_changed', ({ paused }) => {
              if (paused) player.resume();
            });
            player.addListener('ready', ({ device_id }) => {
              // transfer playback here
              fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + access_token,
                  'Content-Type':  'application/json'
                },
                body: JSON.stringify({ device_ids: [ device_id ] })
              });
            });
          }
        });
        document.getElementById('playPause').onclick = () => player.togglePlay();
      };
    }

    // 6) Search for tracks
    document.getElementById('searchBtn').onclick = searchTracks;
    async function searchTracks() {
      const q = document.getElementById('searchQuery').value.trim();
      if (!q) return alert('Enter a search term');
      const res = await fetch(
        `https://api.spotify.com/v1/search?type=track&limit=10&q=` 
        + encodeURIComponent(q),
        { headers: { 'Authorization': 'Bearer ' + access_token } }
      );
      const { tracks } = await res.json();
      const ul = document.getElementById('searchResults');
      ul.innerHTML = '';
      tracks.items.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.name} — ${t.artists.map(a=>a.name).join(', ')}`;
        li.onclick = () => addTrackToPlaylist(
          document.getElementById('playlistSelect').value,
          t.uri
        );
        ul.appendChild(li);
      });
    }

    // 7) Add track URI to selected playlist
    async function addTrackToPlaylist(playlistId, trackUri) {
      const res = await fetch(
        `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + access_token,
            'Content-Type':  'application/json'
          },
          body: JSON.stringify({ uris: [ trackUri ] })
        }
      );
      if (res.ok) {
        alert('✅ Track added!');
      } else {
        console.error(await res.json());
        alert('❌ Failed to add track—see console.');
      }
    }
  </script>
</body>
</html>